Mobile Charter - Medical Center Audio Transcription Management System
================================================================================

QUICK START CONTEXT FOR NEW CONVERSATIONS
If you're starting a new conversation about this project, this document contains everything you need to know about the system, its architecture, features, known issues, and solutions.

================================================================================
1. PROJECT OVERVIEW
================================================================================

Mobile Charter is a comprehensive medical center management system focused on audio transcription workflow for healthcare staff. The system manages audio recordings from patient rooms, provides real-time transcription capabilities, and implements an approval workflow for clinical notes.

Key Purpose:
- Staff (nurses, doctors) receive live audio transcriptions from patient rooms
- They can review, edit, and approve these transcriptions
- Approved notes move to an archived section for record keeping
- Real-time updates ensure immediate notification of new transcriptions

Target Users:
- Medical center staff (nurses, doctors)
- Administrators managing room assignments and bed allocation
- Multiple medical centers: JPCH, EHC, EMC, KMC, PVM

================================================================================
2. SYSTEM ARCHITECTURE & TECH STACK
================================================================================

Frontend:
- Next.js 14+ with TypeScript
- React components with Tailwind CSS
- Socket.io client for real-time updates
- Audio handling with HTMLAudioElement
- Custom UI components (shadcn/ui-based)

Backend:
- Next.js API routes (TypeScript)
- Prisma ORM with PostgreSQL database
- Python services for audio processing (Charting-Device/)
- Socket.io server for real-time communication

Database (PostgreSQL):
- patient_info: Patient records linked to medical centers
- patient_uploads: Audio transcriptions with approval status
- medicalcenter_info: Hospital/center information
- staff management and room assignments

Key Technologies:
- Audio: WebM/WAV file handling and streaming
- Real-time: Socket.io for live transcription delivery
- Authentication: Cookie-based session management
- File uploads: Audio file storage and serving

================================================================================
3. CORE FEATURES & WORKFLOW
================================================================================

3.1 Live Notes Dashboard
- Real-time table showing unapproved transcriptions (is_approved = false)
- Columns: Index, Date, Time, Patient Notes, Actions
- Audio playback with play/pause controls and loading states
- Inline editing of patient notes via textarea
- Approval workflow with green check button
- Delete functionality for removing unwanted entries
- Room filtering to show transcriptions by specific room
- Connection status indicators (Connected/Disconnected/Receiving)

3.2 Archived Notes System
- Shows approved transcriptions (is_approved = true)
- Same table interface as Live Notes
- Restore functionality to move notes back to Live Notes
- Permanent delete option

3.3 Real-Time Audio Transcription Flow
1. Audio recorded in patient rooms via Charting-Device Python services
2. Files uploaded to /uploads/Audio/[CENTER]/[FILES] or /uploads/room_aud/
3. Transcription data sent via Socket.io to live dashboard
4. Staff see new entries highlighted in red initially
5. Staff can edit notes, then approve to move to archived section

3.4 Audio Management
- Preloading system for smooth playback (first 3 files cached)
- Audio caching with LRU eviction (MAX_CACHE = 10)
- Support for both .wav and .webm formats
- Automatic audio element cleanup

3.5 User Management & Roles
- Center selection (JPCH, EHC, EMC, KMC, PVM)
- Staff authentication with role-based dashboards
- Admin dashboard for room and bed management
- Room assignment and bed allocation features

================================================================================
4. CRITICAL BUG FIXES & SOLUTIONS IMPLEMENTED
================================================================================

4.1 MAJOR FIX: Transcription Approval API Route Mismatch (SOLVED)
Problem: HTTP 404 error on approve button - "PATCH /api/staff/transcriptions/7/1000/approve 404"

Root Cause:
- API route expected: /api/staff/transcriptions/[id]/approve (single combined ID)
- Frontend was calling: /api/staff/transcriptions/7/1000/approve (separate patient_id/session_id)

Solution Applied:
- Fixed DataTable.tsx handleApprove function
- Changed from: `/api/staff/transcriptions/${patientId}/${sessionId}/approve`
- To: `/api/staff/transcriptions/${rowId}/approve`
- Where rowId = `${patient_id}_${session_id}`

File: /components/DataTable.tsx:448

4.2 MAJOR FIX: Date/Time Formatting Inconsistency Between Live and Archived Notes (SOLVED)
Problem: When transcriptions move from Live Notes to Archived Notes, the date/time format changes:
- Live Notes: "2178 B", "August 29, 2025", "10:47 PM" (Room, Date, Time)
- Archived Notes: "Jim Pattison Children's Hospital", "1970-01-01T04:48:59.719Z", "Patient JPCH 1"

Root Cause:
- API was returning raw database fields without consistent formatting
- Live Notes received formatted data from Socket.io
- Archived Notes received raw database timestamps and different column mappings

Solution Applied:
- Updated /app/api/staff/transcriptions/route.ts to format dates consistently
- Updated /app/api/staff/transcriptions-by-room/route.ts with same formatting
- Date formatting: toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
- Time formatting: toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
- Column mapping now consistent: column1=Room/Patient, column2=Date, column3=Time, column4=Notes

Files Modified:
- /app/api/staff/transcriptions/route.ts:50-73
- /app/api/staff/transcriptions-by-room/route.ts:56-79

4.3 MAJOR FIX: Archived Notes Delete Not Working + Date Shows 1969 (SOLVED)
Problem 1: Delete button in Archived Notes removed items from UI but they reappeared after refresh
Problem 2: Dates showing as "December 31, 1969" instead of current dates

Root Causes:
1. DELETE API endpoint did not exist - ArchivedNotes was calling non-existent `/api/staff/transcriptions/${patientId}/${sessionId}`
2. Database records had invalid/null upload_time values causing Unix epoch (0) to display as Dec 31, 1969

Solution Applied:
1. Created DELETE method in /app/api/staff/transcriptions/[id]/route.ts
2. Fixed ArchivedNotes.tsx to use correct API route format `/api/staff/transcriptions/${rowId}`
3. Added date validation in both API routes to handle invalid timestamps
4. Invalid dates now fallback to current date instead of epoch

Files Modified:
- /app/api/staff/transcriptions/[id]/route.ts:37-59 (added DELETE method)
- /components/ArchivedNotes.tsx:158 (fixed API route)
- /app/api/staff/transcriptions/route.ts:52-54 (date validation)
- /app/api/staff/transcriptions-by-room/route.ts:58-60 (date validation)

4.4 MAJOR FIX: Transcriptions Lost on Refresh + Not Saved Outside Data Tab (SOLVED)
Problem 1: New transcriptions disappeared when refreshing Live Notes tab
Problem 2: Transcriptions made while not on Data tab were lost completely

Root Causes:
1. New transcriptions only existed in component state, never saved to database until approval
2. Socket.io connection only worked when DataTable component was mounted (Data tab active)
3. No global state management for transcriptions across tabs

Solution Applied:
1. Auto-save new transcriptions to database immediately as unapproved entries
2. Implemented global SocketProvider for cross-tab Socket.io connection
3. Updated approval API to support saving with is_approved=false
4. Modified socket context to handle auto-save for all new transcriptions
5. Updated DataTable to use global socket context instead of local connection

Technical Implementation:
- Modified socket context to auto-save new transcriptions via API
- Added is_approved parameter to approval API route
- Wrapped Staff dashboard with SocketProvider
- Replaced DataTable's local socket with global useSocket hook
- New transcriptions now persist across page refreshes and tab switches

Files Modified:
- /components/context/socket.tsx:37-93 (auto-save logic)
- /app/api/staff/transcriptions/[id]/approve/route.ts:42 (is_approved support)
- /app/Staff/dashboard/page.tsx:11,50 (SocketProvider wrapper)
- /components/DataTable.tsx:10,131,310-349 (global socket integration)

4.5 Database Integration Fixes
- Fixed patient_id and session_id composite key handling
- Resolved Prisma schema compatibility with existing data
- Added is_approved field to patient_uploads table for workflow

4.6 Socket.io Connection Management
- Implemented connection status tracking
- Added reconnection logic for dropped connections
- Visual indicators for real-time data flow

================================================================================
5. FILE STRUCTURE & KEY COMPONENTS
================================================================================

Key Frontend Files:
- /components/DataTable.tsx - Main transcription table (700+ lines)
- /components/ArchivedNotes.tsx - Approved transcriptions view
- /components/UnassignedNotes.tsx - Unassigned transcription handling
- /app/api/staff/transcriptions/[id]/approve/route.ts - Approval API endpoint
- /app/api/staff/transcriptions/route.ts - Main transcriptions API

Database:
- /prisma/schema.prisma - Database schema
- /medicalcentersdb.sql - Database structure
- /prisma/migrations/ - Database migration history

Python Services:
- /Charting-Device/remote.py - Audio capture and processing
- /Charting-Device/functions.py - Utility functions
- /Charting-Device/db.py - Database operations

Audio Storage:
- /uploads/Audio/[CENTER]/ - Organized by medical center
- /uploads/room_aud/ - General room audio storage
- /Charting-Device/uploads/ - Legacy audio storage

================================================================================
6. DATABASE SCHEMA (KEY TABLES)
================================================================================

patient_uploads (main transcription table):
- patient_id (int) + session_id (int) = composite primary key
- upload_path: path to audio file
- patient_notes: transcribed/edited text
- upload_time: timestamp
- is_approved: boolean (false = live notes, true = archived)

patient_info:
- patient_id: primary key
- Links to medicalcenter_info

medicalcenter_info:
- center_name: "Jim Pattison Children's Hospital", etc.
- Links patients to specific medical centers

================================================================================
7. API ENDPOINTS
================================================================================

GET /api/staff/transcriptions
- Fetch all transcriptions for current staff member
- Returns both approved and unapproved

GET /api/staff/transcriptions-by-room?room=[ROOM_NAME]
- Filter transcriptions by specific room
- Used for room-based filtering in dashboard

PATCH /api/staff/transcriptions/[id]/approve
- Approve transcription (set is_approved = true)
- [id] format: "patient_id_session_id" (e.g., "7_1000")
- For new transcriptions: handles "new_transcription_[uuid]" format

PATCH /api/staff/transcriptions/[id]
- Edit transcription content
- Update patient_notes field

DELETE /api/staff/transcriptions/[id]
- Delete transcription record

PATCH /api/staff/transcriptions/[id]/restore
- Restore archived note back to live notes (set is_approved = false)

================================================================================
8. KNOWN ISSUES & FUTURE IMPROVEMENTS
================================================================================

8.1 Current Challenges:
- DataTable.tsx is 700+ lines and needs refactoring
- Audio preloading could be optimized for larger datasets
- Error handling for network failures needs improvement
- Role-based permissions not fully implemented

8.2 Recommended Improvements:
- Extract smaller components from DataTable.tsx:
  * AudioPlayerButton
  * EditableCell  
  * TableStatusBar
  * ActionButtons
- Implement comprehensive error boundaries
- Add pagination for large transcription lists
- Enhanced filtering and search capabilities
- Better mobile responsiveness

8.3 Security Considerations:
- Audio files should have access controls
- Transcription approval should have audit trails
- Staff permissions need granular controls

================================================================================
9. DEVELOPMENT COMMANDS
================================================================================

Setup:
```bash
npm install
npx prisma generate
npx prisma migrate dev
npm run dev
```

Database:
```bash
npx prisma studio  # Database GUI
npx prisma migrate reset  # Reset database
```

Testing:
```bash
npm run build  # Production build test
npm run lint   # Code linting
```

================================================================================
10. SOCKET.IO EVENTS
================================================================================

Client-side events handled:
- 'new_transcription' - New audio transcription received
- 'connect' - Socket connection established  
- 'disconnect' - Socket connection lost
- 'receiving' - Data actively being received

Data format for new_transcription:
```javascript
{
  id: "new_transcription_[uuid]",
  audioUrl: "/path/to/audio.webm",
  column1: "date",
  column2: "time", 
  column3: "room_info",
  column4: "transcribed_text",
  isNew: true,
  isApproved: false
}
```

================================================================================
11. DEBUGGING TIPS
================================================================================

Common Issues:
1. 404 on approval: Check API route structure matches frontend calls
2. Socket not connecting: Verify Socket.io server is running
3. Audio not playing: Check file paths and CORS settings
4. Database errors: Run `npx prisma generate` after schema changes

Useful Console Commands:
- Check socket status: Look for connection badges in UI
- Audio cache: Check browser Network tab for preloaded files
- Database: Use Prisma Studio to inspect data directly

================================================================================
CONCLUSION
================================================================================

This is a production medical transcription system with real-time capabilities. The main workflow is: audio recording → live transcription → staff review/edit → approval → archived storage. The recent fix for the approval API route mismatch resolved the critical 404 error that was preventing the approval workflow from functioning.

Key files to focus on for future development:
- DataTable.tsx (main UI component)
- /api/staff/transcriptions/ routes (backend logic)
- Prisma schema (database structure)
- Socket context (real-time functionality)